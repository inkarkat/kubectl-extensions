#!/bin/bash

typeset -a kubectlArgs=()
typeset -a kubectlNamespaceArgs=()
typeset -a kubectlContainerArgs=()
typeset -a kubectlFollowArgs=()
hasTailArg=
isBoth=
while [ $# -ne 0 ]
do
    case "$1" in
	--namespace|-n)	kubectlNamespaceArgs+=("$1" "$2"); shift; shift;;
	--container|-c)	kubectlContainerArgs+=("$1" "$2"); shift; shift;;
	--container=*)	kubectlContainerArgs+=("$1"); shift;;

	--tail)		hasTailArg=t; kubectlArgs+=("$1" "${2?}"); shift; shift;;
	--tail=*)	hasTailArg=t; kubectlArgs+=("$1"); shift;;
	--follow|-f)	kubectlFollowArgs+=("$1"); shift;;

	--both|-b)	isBoth=t; shift;;
	--)		kubectlArgs+=("$1"); shift; break;;
	*)		kubectlArgs+=("$1"); shift;;
    esac
done
# Default container unless given.
[ -z "$KUBECTL_DEFAULT_CONTAINER" ] || [ ${#kubectlContainerArgs[@]} -gt 0 ] || kubectlContainerArgs=(--container "$KUBECTL_DEFAULT_CONTAINER")

if [ "$isBoth" ]; then
    "${PAGER:-less}" --force \
	<(kubectl "${kubectlNamespaceArgs[@]}" logs "${kubectlContainerArgs[@]}" --previous "${kubectlArgs[@]}" "$@") \
	<(kubectl "${kubectlNamespaceArgs[@]}" logs "${kubectlContainerArgs[@]}" "${kubectlFollowArgs[@]}" "${kubectlArgs[@]}" "$@")
    exit $?
fi

if [ ${#kubectlFollowArgs[@]} -gt 0 ] && [ ! "$hasTailArg" ]; then
    # DWIM: When following, only start with a terminal's height worth of lines,
    # to avoid needless scrolling of outdated logs. (This is especially
    # important when the filteredlogs variant comments on some lines.)
    kubectlFollowArgs+=(--tail=${LINES:-25})
fi

exec kubectl "${kubectlNamespaceArgs[@]}" logs "${kubectlContainerArgs[@]}" "${kubectlFollowArgs[@]}" "${kubectlArgs[@]}" "$@"
